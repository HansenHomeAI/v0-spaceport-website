name: CDK Deploy

on:
  push:
    branches: [ main, development, 'agent-*', ml-development, email-notifications ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    permissions:
      id-token: write   # for GitHub OIDC
      contents: read
    defaults:
      run:
        working-directory: infrastructure/spaceport_cdk

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: infrastructure/spaceport_cdk/requirements.txt

    - name: Cache Node modules
      uses: actions/cache@v3
      with:
        path: web/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Cache npm global packages
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-global-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-global-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install specific versions to avoid dependency resolution issues
        pip install aws-cdk-lib==2.89.0 constructs==10.3.0 boto3==1.28.0 --no-deps
        pip install pytest jsii cattrs typeguard typing-extensions publication --no-deps
        # Now install all dependencies
        pip install -e .
        # Pin CDK CLI to match aws-cdk-lib to avoid qualifier context mismatches
        npm install -g aws-cdk@2.89.0
        # Build Next.js site for Cloudflare (placeholder; wired in follow-up steps)
        cd ../../web && (npm ci || npm install) && (npm run build || true)
        cd -

    - name: Configure AWS credentials (production via OIDC)
      if: github.ref_name == 'main'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: us-west-2

    - name: Configure AWS credentials (staging via access keys)
      if: github.ref_name != 'main'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: CDK Bootstrap (if needed)
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        
        BOOTSTRAP_PARAMETER="/cdk-bootstrap/hnb659fds/version"
        BOOTSTRAP_BUCKET="cdk-hnb659fds-assets-${ACCOUNT}-us-west-2"
        
        BOOTSTRAP_REQUIRED=0
        
        # Check if CDK is bootstrapped with default qualifier
        if aws ssm get-parameter --name "$BOOTSTRAP_PARAMETER" --region us-west-2 >/dev/null 2>&1; then
          echo "CDK already bootstrapped with default qualifier for account $ACCOUNT (SSM parameter present)"
        else
          echo "Default qualifier parameter missing or inaccessible for account $ACCOUNT."
          BOOTSTRAP_REQUIRED=1
          
          if aws s3api head-bucket --bucket "$BOOTSTRAP_BUCKET" >/dev/null 2>&1; then
            echo "Bootstrap assets bucket $BOOTSTRAP_BUCKET already exists."
            echo "Removing all object versions from bootstrap bucket before deletion..."
            
            KEY_MARKER=""
            VERSION_MARKER=""
            while true; do
              if [ -n "$KEY_MARKER" ]; then
                RESPONSE=$(aws s3api list-object-versions --bucket "$BOOTSTRAP_BUCKET" --key-marker "$KEY_MARKER" --version-id-marker "$VERSION_MARKER")
              else
                RESPONSE=$(aws s3api list-object-versions --bucket "$BOOTSTRAP_BUCKET")
              fi
              
              OBJECTS_JSON=$(echo "$RESPONSE" | jq -c '{
                Objects: (
                  ((.Versions // []) + (.DeleteMarkers // []))
                  | map({Key: .Key, VersionId: .VersionId})
                )
              }')
              
              COUNT=$(echo "$OBJECTS_JSON" | jq '.Objects | length')
              if [ "$COUNT" -gt 0 ]; then
                echo "$OBJECTS_JSON" > /tmp/delete-bootstrap-objects.json
                aws s3api delete-objects --bucket "$BOOTSTRAP_BUCKET" --delete file:///tmp/delete-bootstrap-objects.json >/dev/null
              fi
              
              if [ "$(echo "$RESPONSE" | jq -r '.IsTruncated')" != "true" ]; then
                break
              fi
              
              KEY_MARKER=$(echo "$RESPONSE" | jq -r '.NextKeyMarker // empty')
              VERSION_MARKER=$(echo "$RESPONSE" | jq -r '.NextVersionIdMarker // empty')
              
              if [ -z "$KEY_MARKER" ]; then
                break
              fi
            done
            rm -f /tmp/delete-bootstrap-objects.json
            
            echo "Deleting bootstrap bucket $BOOTSTRAP_BUCKET..."
            aws s3api delete-bucket --bucket "$BOOTSTRAP_BUCKET" --region us-west-2
          else
            echo "Bootstrap assets bucket $BOOTSTRAP_BUCKET not found."
          fi
          
          echo "Checking for existing CDK bootstrap stack..."
          if aws cloudformation describe-stacks --stack-name CDKToolkit --region us-west-2 >/dev/null 2>&1; then
            echo "Found existing CDKToolkit stack. Deleting to ensure clean bootstrap with default qualifier..."
            aws cloudformation delete-stack --stack-name CDKToolkit --region us-west-2
            echo "Waiting for stack deletion to complete..."
            aws cloudformation wait stack-delete-complete --stack-name CDKToolkit --region us-west-2
            echo "Existing CDK bootstrap stack deleted successfully"
          fi
        fi
        
        if [ "$BOOTSTRAP_REQUIRED" -eq 1 ]; then
          echo "Bootstrapping environment $ACCOUNT/us-west-2 with default qualifier resources..."
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "Production bootstrap with OIDC role trust and default qualifier"
            cdk bootstrap aws://$ACCOUNT/us-west-2 \
              --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess \
              --trust arn:aws:iam::$ACCOUNT:role/GithubActionsProdRole
          else
            echo "Development bootstrap with default qualifier"
            cdk bootstrap aws://$ACCOUNT/us-west-2
          fi
        fi

    - name: Verify Bootstrap
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        echo "Verifying CDK bootstrap for account $ACCOUNT"

        BOOTSTRAP_PARAMETER="/cdk-bootstrap/hnb659fds/version"
        BOOTSTRAP_BUCKET="cdk-hnb659fds-assets-${ACCOUNT}-us-west-2"
        
        # Simple verification - prefer SSM parameter, fall back to bucket existence
        echo "Checking for default qualifier bootstrap artifacts..."
        if aws ssm get-parameter --name "$BOOTSTRAP_PARAMETER" --region us-west-2 >/dev/null 2>&1; then
          echo "✅ CDK bootstrap verified successfully via SSM parameter"
        elif aws s3api head-bucket --bucket "$BOOTSTRAP_BUCKET" >/dev/null 2>&1; then
          echo "✅ CDK bootstrap assets bucket exists; treating environment as bootstrapped"
        else
          echo "❌ Unable to verify CDK bootstrap state (missing SSM parameter and assets bucket)"
          echo "Manual intervention required before continuing deployment"
          exit 1
        fi

    # Removed dangerous cleanup script - production stacks should not be deleted automatically

    - name: Deploy CDK Stacks
      if: github.event_name == 'push'
      env:
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        # Stripe secrets for staging environment (CDK expects _TEST suffix for staging)
        STRIPE_SECRET_KEY_TEST: ${{ secrets.STRIPE_SECRET_KEY_STAGING }}
        STRIPE_WEBHOOK_SECRET_STAGING: ${{ secrets.STRIPE_WEBHOOK_SECRET_STAGING }}
        STRIPE_PRICE_SINGLE_STAGING: ${{ secrets.STRIPE_PRICE_SINGLE_STAGING }}
        STRIPE_PRICE_STARTER_STAGING: ${{ secrets.STRIPE_PRICE_STARTER_STAGING }}
        STRIPE_PRICE_GROWTH_STAGING: ${{ secrets.STRIPE_PRICE_GROWTH_STAGING }}
        # Stripe secrets for production environment
        STRIPE_SECRET_KEY_PROD: ${{ secrets.STRIPE_SECRET_KEY_PROD }}
        STRIPE_WEBHOOK_SECRET_PROD: ${{ secrets.STRIPE_WEBHOOK_SECRET_PROD }}
        STRIPE_PRICE_SINGLE_PROD: ${{ secrets.STRIPE_PRICE_SINGLE_PROD }}
        STRIPE_PRICE_STARTER_PROD: ${{ secrets.STRIPE_PRICE_STARTER_PROD }}
        STRIPE_PRICE_GROWTH_PROD: ${{ secrets.STRIPE_PRICE_GROWTH_PROD }}
        GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        CDK_DISABLE_BOOTSTRAP_VERSION_CHECK: "1"
        # Referral system configuration - using CDK defaults (Option A)
        # REFERRAL_KICKBACK_PERCENTAGE: 10 (default)
        # EMPLOYEE_KICKBACK_PERCENTAGE: 30 (default) 
        # COMPANY_KICKBACK_PERCENTAGE: 70 (default)
        # REFERRAL_DURATION_MONTHS: 6 (default)
        # EMPLOYEE_USER_ID: "" (optional)
        # FRONTEND_URL: "https://spcprt.com" (default)
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        BRANCH_NAME="${GITHUB_REF_NAME}"

        if [ -z "${GOOGLE_MAPS_API_KEY:-}" ]; then
          echo "GOOGLE_MAPS_API_KEY secret is empty or unavailable for this workflow/environment"
          exit 1
        fi
        
        # Detect Lambda function changes
        LAMBDA_CHANGED="false"
        if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
          # Check if any Lambda files changed
          if git diff --name-only HEAD~1 HEAD | grep -q "^infrastructure/spaceport_cdk/lambda/"; then
            LAMBDA_CHANGED="true"
            echo "Lambda functions changed - will deploy branch-specific Lambda versions"
          fi
        fi
        
        # Determine environment based on branch
        if [ "${BRANCH_NAME}" = "main" ]; then
          ENVIRONMENT="production"
          echo "Deploying to production environment"
        elif [ "${BRANCH_NAME}" = "development" ]; then
          ENVIRONMENT="staging"
          echo "Deploying to staging environment"
        else
          # For agent/feature branches, use staging as base but with branch-specific suffix
          ENVIRONMENT="staging"
          echo "Deploying agent branch: ${BRANCH_NAME} (using staging environment with branch-specific resources)"
        fi
        
        # Sanitize branch name for AWS resource naming (remove invalid chars, lowercase)
        # This matches the Python sanitize_branch_name function logic
        BRANCH_SANITIZED=$(echo "${BRANCH_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-50)
        if [ -z "${BRANCH_SANITIZED}" ]; then
          BRANCH_SANITIZED="default"
        fi
        
        echo "Branch name: ${BRANCH_NAME}"
        echo "Sanitized branch suffix: ${BRANCH_SANITIZED}"
        echo "Lambda changed: ${LAMBDA_CHANGED}"

        STACK_ID_SUFFIX=""
        if [ "${BRANCH_NAME}" != "main" ] && [ "${BRANCH_NAME}" != "development" ] && [ "${BRANCH_NAME}" != "ml-development" ]; then
          STACK_ID_SUFFIX="${BRANCH_SANITIZED^}"
        fi

        SPACEPORT_STACK_NAME="Spaceport${ENVIRONMENT^}Stack${STACK_ID_SUFFIX}"
        
        # Deploy all stacks with environment context and branch name
        cdk deploy --all \
          --require-approval never \
          --no-fail-on-empty-changeset \
          --context environment=$ENVIRONMENT \
          --context branch="${BRANCH_NAME}" \
          --context lambdaChanged=$LAMBDA_CHANGED \
          --context account=$ACCOUNT \
          --context region=us-west-2 \
          --parameters "${SPACEPORT_STACK_NAME}:GoogleMapsApiKey=${GOOGLE_MAPS_API_KEY}"

    - name: Update Frontend Environment Variables
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        
        # Determine environment based on branch
        if [ "${GITHUB_REF_NAME}" = "main" ]; then
          ENVIRONMENT="production"
          SECRET_SUFFIX="PROD"
        else
          ENVIRONMENT="staging"
          SECRET_SUFFIX="PREVIEW"
        fi

        BRANCH_SANITIZED=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-50)
        STACK_ID_SUFFIX=""
        if [ "${GITHUB_REF_NAME}" != "main" ] && [ "${GITHUB_REF_NAME}" != "development" ] && [ "${GITHUB_REF_NAME}" != "ml-development" ]; then
          STACK_ID_SUFFIX="${BRANCH_SANITIZED^}"
        fi
        
        # Get CDK stack outputs
        STACK_NAME="Spaceport${ENVIRONMENT^}Stack${STACK_ID_SUFFIX}"
        DRONE_PATH_API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='DronePathApiUrl'].OutputValue" --output text)
        FILE_UPLOAD_API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='FileUploadApiUrl'].OutputValue" --output text)
        
        # Get Auth stack outputs
        AUTH_STACK_NAME="SpaceportAuth${ENVIRONMENT^}Stack${STACK_ID_SUFFIX}"
        PROJECTS_API_URL=$(aws cloudformation describe-stacks --stack-name $AUTH_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ProjectsApiUrl'].OutputValue" --output text)
        
        # Get ML Pipeline stack outputs
        ML_STACK_NAME="SpaceportMLPipeline${ENVIRONMENT^}Stack${STACK_ID_SUFFIX}"
        ML_PIPELINE_API_URL=$(aws cloudformation describe-stacks --stack-name $ML_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='MLPipelineApiUrl'].OutputValue" --output text)
        
        echo "Retrieved API URLs:"
        echo "Drone Path API: $DRONE_PATH_API_URL"
        echo "File Upload API: $FILE_UPLOAD_API_URL"
        echo "Projects API: $PROJECTS_API_URL"
        echo "ML Pipeline API: $ML_PIPELINE_API_URL"
        
        # Note: In a real deployment, you would update GitHub secrets here
        # This requires a GitHub token with appropriate permissions
        # For now, we'll just output the values for manual update

    - name: CDK Diff
      if: github.event_name == 'pull_request'
      run: npx cdk diff 
