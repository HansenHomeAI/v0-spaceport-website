name: CDK Deploy

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    permissions:
      id-token: write   # for GitHub OIDC
      contents: read
    defaults:
      run:
        working-directory: infrastructure/spaceport_cdk

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install specific versions to avoid dependency resolution issues
        pip install aws-cdk-lib==2.89.0 constructs==10.3.0 boto3==1.28.0 --no-deps
        pip install pytest jsii cattrs typeguard typing-extensions publication --no-deps
        # Now install all dependencies
        pip install -e .
        # Pin CDK CLI to match aws-cdk-lib to avoid qualifier context mismatches
        npm install -g aws-cdk@2.89.0
        # Build Next.js site for Cloudflare (placeholder; wired in follow-up steps)
        cd ../../web && npm ci || npm install && npm run build || true
        cd -

    - name: Configure AWS credentials (production via OIDC)
      if: github.ref_name == 'main'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: us-west-2

    - name: Configure AWS credentials (staging via access keys)
      if: github.ref_name != 'main'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: CDK Bootstrap (if needed)
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        
        # Check for CDK bootstrap using the correct SSM parameter path
        # CDK v2 uses the default qualifier 'hnb659fds'
        BOOTSTRAP_SSM_PATH="/cdk-bootstrap/hnb659fds/version"
        
        echo "Checking for existing CDK bootstrap..."
        if ! aws ssm get-parameter --name "$BOOTSTRAP_SSM_PATH" --region us-west-2 2>/dev/null; then
          echo "CDK not bootstrapped. Bootstrapping for account $ACCOUNT..."
          
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "Production bootstrap with OIDC role trust"
            cdk bootstrap aws://$ACCOUNT/us-west-2 \
              --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess \
              --trust arn:aws:iam::$ACCOUNT:role/GithubActionsProdRole \
              --verbose
          else
            echo "Development bootstrap"
            cdk bootstrap aws://$ACCOUNT/us-west-2 \
              --verbose
          fi
          
          # Verify bootstrap completed successfully
          echo "Verifying bootstrap completion..."
          for i in {1..10}; do
            if aws ssm get-parameter --name "$BOOTSTRAP_SSM_PATH" --region us-west-2 2>/dev/null; then
              echo "✅ CDK bootstrap verified successfully"
              break
            fi
            echo "Waiting for bootstrap to complete... (attempt $i/10)"
            sleep 5
          done
        else
          echo "✅ CDK already bootstrapped for account $ACCOUNT"
        fi

    - name: Verify Bootstrap
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        echo "Verifying CDK bootstrap for account $ACCOUNT"

        # Prefer SSM parameter check for default qualifier, else fall back to CFN stack state
        # Default CDK v2 qualifier is 'hnb659fds'
        PARAM_NAME="/cdk-bootstrap/hnb659fds/version"

        # Exponential backoff attempts
        for ATTEMPT in 1 2 3 4 5; do
          echo "Attempt $ATTEMPT of 5 to verify bootstrap..."
          if aws ssm get-parameter --name "$PARAM_NAME" --region us-west-2 >/dev/null 2>&1; then
            echo "Found SSM bootstrap parameter: $PARAM_NAME"
            FOUND=1
            break
          fi

          # Fall back to checking CloudFormation stack status
          STATUS=$(aws cloudformation describe-stacks --stack-name CDKToolkit --region us-west-2 --query "Stacks[0].StackStatus" --output text 2>/dev/null || echo "NOT_FOUND")
          if [ "$STATUS" = "CREATE_COMPLETE" ] || [ "$STATUS" = "UPDATE_COMPLETE" ]; then
            echo "CDKToolkit stack status is $STATUS"
            FOUND=1
            break
          fi

          SLEEP=$((2 ** (ATTEMPT - 1)))
          echo "Bootstrap not ready yet (status=$STATUS). Waiting ${SLEEP}s..."
          sleep $SLEEP
        done

        if [ "${FOUND:-0}" != "1" ]; then
          echo "Failed to verify bootstrap after retries"
          echo "Hint: Ensure 'cdk bootstrap' ran successfully and the default qualifier 'hnb659fds' is used."
          exit 1
        fi
        echo "CDK bootstrap verified successfully"

    # Removed dangerous cleanup script - production stacks should not be deleted automatically

    - name: Deploy CDK Stacks
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        
        # Determine environment based on branch
        if [ "${GITHUB_REF_NAME}" = "main" ]; then
          ENVIRONMENT="production"
          echo "Deploying to production environment"
        else
          ENVIRONMENT="staging"
          echo "Deploying to staging environment"
        fi
        
        # Deploy all stacks with environment context
        cdk deploy --all \
          --require-approval never \
          --no-fail-on-empty-changeset \
          --context environment=$ENVIRONMENT \
          --context account=$ACCOUNT \
          --context region=us-west-2 \
          --parameters Spaceport${ENVIRONMENT^}Stack:GoogleMapsApiKey=${{ secrets.GOOGLE_MAPS_API_KEY }}

    - name: Update Frontend Environment Variables
      if: github.event_name == 'push'
      run: |
        set -e
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        
        # Determine environment based on branch
        if [ "${GITHUB_REF_NAME}" = "main" ]; then
          ENVIRONMENT="production"
          SECRET_SUFFIX="PROD"
        else
          ENVIRONMENT="staging"
          SECRET_SUFFIX="PREVIEW"
        fi
        
        # Get CDK stack outputs
        STACK_NAME="Spaceport${ENVIRONMENT^}Stack"
        DRONE_PATH_API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='DronePathApiUrl'].OutputValue" --output text)
        FILE_UPLOAD_API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='FileUploadApiUrl'].OutputValue" --output text)
        
        # Get Auth stack outputs
        AUTH_STACK_NAME="SpaceportAuth${ENVIRONMENT^}Stack"
        PROJECTS_API_URL=$(aws cloudformation describe-stacks --stack-name $AUTH_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ProjectsApiUrl'].OutputValue" --output text)
        
        # Get ML Pipeline stack outputs
        ML_STACK_NAME="SpaceportMLPipeline${ENVIRONMENT^}Stack"
        ML_PIPELINE_API_URL=$(aws cloudformation describe-stacks --stack-name $ML_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='MLPipelineApiUrl'].OutputValue" --output text)
        
        echo "Retrieved API URLs:"
        echo "Drone Path API: $DRONE_PATH_API_URL"
        echo "File Upload API: $FILE_UPLOAD_API_URL"
        echo "Projects API: $PROJECTS_API_URL"
        echo "ML Pipeline API: $ML_PIPELINE_API_URL"
        
        # Note: In a real deployment, you would update GitHub secrets here
        # This requires a GitHub token with appropriate permissions
        # For now, we'll just output the values for manual update

    - name: CDK Diff
      if: github.event_name == 'pull_request'
      run: npx cdk diff 