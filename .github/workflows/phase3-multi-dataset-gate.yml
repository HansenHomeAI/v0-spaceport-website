name: Phase 3 Multi-Dataset Gate

on:
  workflow_run:
    workflows:
      - CDK Deploy
    types:
      - completed

jobs:
  phase3-dry-run-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Guard on successful push-triggered CDK Deploy
      env:
        CDK_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        CDK_EVENT: ${{ github.event.workflow_run.event }}
      run: |
        # Phase 3 runs only after a successful CDK Deploy on a push.
        if [ "$CDK_CONCLUSION" != "success" ] || [ "$CDK_EVENT" != "push" ]; then
          echo "Skipping Phase 3 gate: conclusion=$CDK_CONCLUSION event=$CDK_EVENT"
          exit 0
        fi

      - name: Checkout exact SHA validated by CDK Deploy
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

      - name: Verify metrics protocol doc exists
      run: test -f docs/benchmarks/METRICS_PROTOCOL.md

      - name: Run multi-dataset evaluator dry-run
      run: |
        python3 scripts/bench/run_multi_dataset_eval.py \
          --dry-run \
          --run-id ci-phase3-${{ github.event.workflow_run.run_number }} \
          --output-dir /tmp/phase3-metrics

      - name: Verify evaluator output summary
      run: test -f /tmp/phase3-metrics/ci-phase3-${{ github.event.workflow_run.run_number }}/summary.json
