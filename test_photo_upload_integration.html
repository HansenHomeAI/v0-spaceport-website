<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Upload Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .test-button {
            background: #FF4F00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #4CAF50;
            color: white;
        }
        .error {
            background: #f44336;
            color: white;
        }
        .upload-zone {
            border: 2px dashed #666;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: #fff;
        }
        .form-field {
            margin: 10px 0;
        }
        .form-field input, .form-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: #fff;
        }
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üöÄ Photo Upload Integration Test</h1>
    
    <div class="test-section">
        <h2>1. API Endpoint Tests</h2>
        <button class="test-button" onclick="testAPIEndpoints()">Test API Connectivity</button>
        <div id="apiTestResults"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Form Validation Tests</h2>
        <div class="form-field">
            <label>Property Title:</label>
            <input type="text" id="testPropertyTitle" placeholder="Test Property">
        </div>
        <div class="form-field">
            <label>Email:</label>
            <input type="email" id="testEmail" placeholder="test@example.com">
        </div>
        <div class="form-field">
            <label>Description:</label>
            <textarea id="testDescription" placeholder="Test description"></textarea>
        </div>
        <button class="test-button" onclick="testFormValidation()">Test Form Validation</button>
        <div id="validationTestResults"></div>
    </div>
    
    <div class="test-section">
        <h2>3. File Upload Test</h2>
        <div class="upload-zone" onclick="selectTestFile()">
            <p>Click to select a test ZIP file</p>
            <p id="selectedFileName" style="color: #4CAF50; display: none;"></p>
        </div>
        <button class="test-button" onclick="testFileUpload()">Test File Upload (Mock)</button>
        <div id="fileTestResults"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Integration Test</h2>
        <p>This will test the complete flow: Form validation ‚Üí Upload ‚Üí ML processing</p>
        <button class="test-button" onclick="testCompleteIntegration()">Test Complete Integration</button>
        <div id="integrationTestResults"></div>
    </div>

    <script>
        let selectedTestFile = null;
        
        // Mock ProjectPopupPhotoUpload for testing
        class MockProjectPopupPhotoUpload {
            constructor() {
                this.API_ENDPOINTS = {
                    START_UPLOAD: "https://o7d0i4to5a.execute-api.us-west-2.amazonaws.com/prod/start-multipart-upload",
                    GET_PRESIGNED_URL: "https://o7d0i4to5a.execute-api.us-west-2.amazonaws.com/prod/get-presigned-url",
                    COMPLETE_UPLOAD: "https://o7d0i4to5a.execute-api.us-west-2.amazonaws.com/prod/complete-multipart-upload",
                    SAVE_SUBMISSION: "https://o7d0i4to5a.execute-api.us-west-2.amazonaws.com/prod/save-submission",
                    START_ML_PROCESSING: "https://3xzfdyvwpd.execute-api.us-west-2.amazonaws.com/prod/start-job"
                };
                
                this.CHUNK_SIZE = 24 * 1024 * 1024; // 24MB chunks
                this.MAX_FILE_SIZE = 5 * 1024 * 1024 * 1024; // 5GB max
                this.isProcessing = false;
            }
            
            validateForm() {
                const propertyTitle = document.getElementById('testPropertyTitle');
                const email = document.getElementById('testEmail');
                const description = document.getElementById('testDescription');
                
                if (!propertyTitle?.value?.trim()) {
                    return { isValid: false, error: 'Property title is required' };
                }
                
                if (!email?.value?.trim()) {
                    return { isValid: false, error: 'Email address is required' };
                }
                
                if (!this.isValidEmail(email.value.trim())) {
                    return { isValid: false, error: 'Please enter a valid email address' };
                }
                
                if (!selectedTestFile) {
                    return { isValid: false, error: 'Please select a .zip file to upload' };
                }
                
                if (!selectedTestFile.name.toLowerCase().endsWith('.zip')) {
                    return { isValid: false, error: 'Please upload a .zip file only' };
                }
                
                if (selectedTestFile.size > this.MAX_FILE_SIZE) {
                    return { isValid: false, error: 'File size exceeds 5GB limit' };
                }
                
                const formData = {
                    propertyTitle: propertyTitle.value.trim(),
                    email: email.value.trim(),
                    listingDescription: description?.value?.trim() || ''
                };
                
                return { isValid: true, file: selectedTestFile, formData };
            }
            
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            async handleUpload() {
                if (this.isProcessing) {
                    return { success: false, error: 'Upload already in progress' };
                }
                
                const validation = this.validateForm();
                if (!validation.isValid) {
                    return { success: false, error: validation.error };
                }
                
                this.isProcessing = true;
                
                try {
                    // Mock successful upload
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Mock ML processing
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    return { 
                        success: true, 
                        message: 'Upload and ML processing started successfully',
                        jobId: 'test-job-123',
                        s3Url: 's3://test-bucket/test-file.zip'
                    };
                } catch (error) {
                    return { success: false, error: error.message };
                } finally {
                    this.isProcessing = false;
                }
            }
        }
        
        const mockUploader = new MockProjectPopupPhotoUpload();
        
        function selectTestFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.zip';
            input.style.display = 'none';
            
            input.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedTestFile = e.target.files[0];
                    document.getElementById('selectedFileName').textContent = `Selected: ${selectedTestFile.name}`;
                    document.getElementById('selectedFileName').style.display = 'block';
                }
                document.body.removeChild(input);
            });
            
            document.body.appendChild(input);
            input.click();
        }
        
        async function testAPIEndpoints() {
            const resultDiv = document.getElementById('apiTestResults');
            resultDiv.innerHTML = '<p>Testing API endpoints...</p>';
            
            const endpoints = [
                { name: 'File Upload API', url: mockUploader.API_ENDPOINTS.START_UPLOAD },
                { name: 'ML Processing API', url: mockUploader.API_ENDPOINTS.START_ML_PROCESSING }
            ];
            
            let results = '';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: 'OPTIONS',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        results += `<div class="test-result success">‚úÖ ${endpoint.name}: Available</div>`;
                    } else {
                        results += `<div class="test-result error">‚ùå ${endpoint.name}: HTTP ${response.status}</div>`;
                    }
                } catch (error) {
                    results += `<div class="test-result error">‚ùå ${endpoint.name}: ${error.message}</div>`;
                }
            }
            
            resultDiv.innerHTML = results;
        }
        
        function testFormValidation() {
            const resultDiv = document.getElementById('validationTestResults');
            
            // Test empty form
            const emptyValidation = mockUploader.validateForm();
            let results = '';
            
            if (!emptyValidation.isValid) {
                results += `<div class="test-result success">‚úÖ Empty form validation: ${emptyValidation.error}</div>`;
            } else {
                results += `<div class="test-result error">‚ùå Empty form validation: Should fail but didn't</div>`;
            }
            
            // Fill form with valid data
            document.getElementById('testPropertyTitle').value = 'Test Property';
            document.getElementById('testEmail').value = 'test@example.com';
            document.getElementById('testDescription').value = 'Test description';
            
            if (selectedTestFile) {
                const validValidation = mockUploader.validateForm();
                if (validValidation.isValid) {
                    results += `<div class="test-result success">‚úÖ Valid form validation: Passed</div>`;
                } else {
                    results += `<div class="test-result error">‚ùå Valid form validation: ${validValidation.error}</div>`;
                }
            } else {
                results += `<div class="test-result error">‚ùå Valid form validation: No file selected</div>`;
            }
            
            resultDiv.innerHTML = results;
        }
        
        function testFileUpload() {
            const resultDiv = document.getElementById('fileTestResults');
            
            if (!selectedTestFile) {
                resultDiv.innerHTML = '<div class="test-result error">‚ùå No file selected</div>';
                return;
            }
            
            let results = '';
            
            // Test file type validation
            if (selectedTestFile.name.toLowerCase().endsWith('.zip')) {
                results += `<div class="test-result success">‚úÖ File type validation: ${selectedTestFile.name} is a ZIP file</div>`;
            } else {
                results += `<div class="test-result error">‚ùå File type validation: ${selectedTestFile.name} is not a ZIP file</div>`;
            }
            
            // Test file size validation
            const maxSize = 5 * 1024 * 1024 * 1024; // 5GB
            if (selectedTestFile.size <= maxSize) {
                results += `<div class="test-result success">‚úÖ File size validation: ${(selectedTestFile.size / (1024 * 1024)).toFixed(2)} MB is within limit</div>`;
            } else {
                results += `<div class="test-result error">‚ùå File size validation: ${(selectedTestFile.size / (1024 * 1024)).toFixed(2)} MB exceeds limit</div>`;
            }
            
            resultDiv.innerHTML = results;
        }
        
        async function testCompleteIntegration() {
            const resultDiv = document.getElementById('integrationTestResults');
            resultDiv.innerHTML = '<p>Testing complete integration...</p>';
            
            // Fill form with test data
            document.getElementById('testPropertyTitle').value = 'Test Property';
            document.getElementById('testEmail').value = 'test@example.com';
            document.getElementById('testDescription').value = 'Test description for integration';
            
            if (!selectedTestFile) {
                resultDiv.innerHTML = '<div class="test-result error">‚ùå Please select a test file first</div>';
                return;
            }
            
            try {
                const result = await mockUploader.handleUpload();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">‚úÖ Complete integration test passed!</div>
                        <div class="test-result success">Job ID: ${result.jobId}</div>
                        <div class="test-result success">S3 URL: ${result.s3Url}</div>
                        <div class="test-result success">Message: ${result.message}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">‚ùå Integration test failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Integration test error: ${error.message}</div>`;
            }
        }
        
        // Auto-run basic tests on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Photo Upload Integration Test Page Loaded');
            
            // Fill form with sample data
            document.getElementById('testPropertyTitle').value = 'Sample Property';
            document.getElementById('testEmail').value = 'test@example.com';
            document.getElementById('testDescription').value = 'Sample description';
        });
    </script>
</body>
</html> 